<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Test Nginx + Flask</title>
</head>
<body>
    <h1>Test Nginx + Python Flask</h1>
    <button id="call-backend">Appeler Backend Python</button>

    <button id="init-bdd">Initialisation BDD</button>
    <pre id="response"></pre>

    <h2>Importer un dossier de CSV</h2>

    <input type="file" id="csvFile" accept=".csv">
    <progress id="progressBar" value="0" max="100"></progress>
    <p id="progressText"></p>
    <button onclick="sendCsv()">Envoyer CSV</button>
    <pre id="response2"></pre>


    <script>
        async function sendCsv() {
            const fileInput = document.getElementById("csvFile");
            const file = fileInput.files[0];
            if (!file) return alert("Sélectionne un fichier CSV");

            const progressBar = document.getElementById("progressBar");
            const progressText = document.getElementById("progressText");
            const response2 = document.getElementById("response2");

            const text = await file.text();
            const lines = text.split(/\r?\n/).filter(l => l.trim() !== "");

            lines.shift();

            const totalLines = lines.length;
            const chunkSize = 100;

            let totalReceived = 0;

            for (let i = 0; i < totalLines; i += chunkSize) {
                const chunk = lines.slice(i, i + chunkSize);

                // POST en JSON pur
                const res = await fetch("/api/upload-csv", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ chunk })
                });

                const result = await res.json();
                totalReceived += result.received;

                const percent = Math.min(100, Math.round((totalReceived / totalLines) * 100));
                progressBar.value = percent;
                progressText.textContent = `${totalReceived} / ${totalLines} lignes envoyées (${percent}%)`;
            }

            response2.textContent = `Upload terminé ! ${totalReceived} lignes traitées.`;
        }



        document.getElementById('call-backend').addEventListener('click', () => {
            fetch('/api/')
                .then(response => response.text())
                .then(data => {
                    document.getElementById('response').textContent = data;
                })
                .catch(err => {
                    document.getElementById('response').textContent = 'Erreur: ' + err;
                });
        });

        document.getElementById('init-bdd').addEventListener('click', () => {
            fetch('/api/init-db')
                .then(response => response.text())
                .then(data => {
                    document.getElementById('response').textContent = data;
                })
                .catch(err => {
                    document.getElementById('response').textContent = 'Erreur: ' + err;
                });
        });
    </script>
</body>
</html>
